### ===========================================
### MÓDULO DE PEDIDOS (ORDERS)
### ===========================================
### Base URL: http://localhost:3000/api/orders
### ===========================================
###
### IMPORTANTE:
### Este módulo é para CONSULTA de pedidos já criados.
### Para CRIAR pedidos, use o módulo /checkout (ver checkout.http)
###
### FLUXO DE CRIAÇÃO (resumo):
### 1. POST /checkout/guest ou /checkout/registered
### 2. POST /checkout/order (com X-Idempotency-Key)
### 3. POST /checkout/payment/:type/gateway/:gateway (com X-Idempotency-Key)
###
### Este arquivo documenta apenas consultas e sincronização.
### ===========================================

@baseUrl = http://localhost:3000/api
@ordersUrl = {{baseUrl}}/orders
@authUrl = {{baseUrl}}/auth
@contentType = application/json

### ===========================================
### AUTENTICAÇÃO
### ===========================================

# @name login
POST {{authUrl}}/signin
Content-Type: {{contentType}}

{
  "email": "usuario@email.com",
  "password": "Senha123"
}

@token = {{login.response.body.access_token}}
@profileId = {{login.response.body.profileId}}

### ===========================================
### 1. LISTAR PEDIDOS DO PERFIL
### ===========================================
### Retorna resumo dos pedidos com filtros opcionais
### Requer: Authorization Bearer token

### Listar todos os pedidos do usuário logado

GET {{ordersUrl}}
Authorization: Bearer {{token}}

### Listar pedidos com filtro por status - PENDENTE
### Status disponíveis: INCOMPLETE, PENDING, WAITING_PAYMENT, PAID_WAITING_SHIP, 
### INVOICED, PAID_WAITING_DELIVERY, IN_TRANSIT, CONCLUDED, CANCELED, DELIVERY_ISSUE

GET {{ordersUrl}}?status=PENDING
Authorization: Bearer {{token}}

### Listar pedidos aguardando pagamento

GET {{ordersUrl}}?status=WAITING_PAYMENT
Authorization: Bearer {{token}}

### Listar pedidos pagos aguardando envio

GET {{ordersUrl}}?status=PAID_WAITING_SHIP
Authorization: Bearer {{token}}

### Listar pedidos em trânsito

GET {{ordersUrl}}?status=IN_TRANSIT
Authorization: Bearer {{token}}

### Listar pedidos concluídos

GET {{ordersUrl}}?status=CONCLUDED
Authorization: Bearer {{token}}

### Listar pedidos cancelados

GET {{ordersUrl}}?status=CANCELED
Authorization: Bearer {{token}}

### Listar pedidos do marketplace ECOMMERCE

GET {{ordersUrl}}?marketplace=ECOMMERCE
Authorization: Bearer {{token}}

### Listar com múltiplos filtros

GET {{ordersUrl}}?status=CONCLUDED&marketplace=ECOMMERCE
Authorization: Bearer {{token}}

### Listar pedidos por período (createdFrom e createdTo)

GET {{ordersUrl}}?createdFrom=2025-12-01&createdTo=2025-12-31
Authorization: Bearer {{token}}

### Listar pedidos combinando todos os filtros

GET {{ordersUrl}}?status=PAID_WAITING_SHIP&marketplace=ECOMMERCE&createdFrom=2025-12-01
Authorization: Bearer {{token}}

### ===========================================
### 2. BUSCAR DETALHES DO PEDIDO
### ===========================================
### Retorna informações completas de um pedido específico
### Requer: Authorization Bearer token

# @name getOrder
GET {{ordersUrl}}/1
Authorization: Bearer {{token}}

@orderId = {{getOrder.response.body.id}}

### Buscar outro pedido

GET {{ordersUrl}}/2
Authorization: Bearer {{token}}

### ===========================================
### 3. SINCRONIZAÇÃO COM ANYMARKET (ADMIN)
### ===========================================
### Endpoint administrativo para sincronizar pedidos do AnyMarket
### Importa pedidos via feed do AnyMarket

POST {{ordersUrl}}/sync
Content-Type: {{contentType}}

### ===========================================
### ESTRUTURA DE RESPOSTA
### ===========================================

### Resposta de GET /orders (lista de pedidos):
### [
###   {
###     "id": 1,
###     "partnerOrderId": "ECOM-42-1702123456789",
###     "status": "PAID_WAITING_SHIP",
###     "marketplace": "ECOMMERCE",
###     "paymentMethod": "CREDIT_CARD",
###     "itemsTotal": "279.70",
###     "shippingTotal": "20.00",
###     "discountTotal": "0.00",
###     "grandTotal": "299.70",
###     "createdAt": "2025-12-13T10:00:00.000Z",
###     "updatedAt": "2025-12-13T10:30:00.000Z",
###     "items": [
###       {
###         "id": 1,
###         "productId": 0,
###         "skuId": 30494035,
###         "title": "Camiseta Exemplo - P Vermelho",
###         "quantity": 2,
###         "unitPrice": "99.90",
###         "discount": "0.00",
###         "total": "199.80"
###       }
###     ]
###   }
### ]

### Resposta de GET /orders/:id (detalhes do pedido):
### {
###   "id": 1,
###   "profileId": 42,
###   "anymarketOrderId": 123456,
###   "partnerOrderId": "ECOM-42-1702123456789",
###   "checkoutKey": "550e8400-e29b-41d4-a716-446655440001",
###   "marketplace": "ECOMMERCE",
###   "marketplaceOrderId": null,
###   "status": "PAID_WAITING_SHIP",
###   "itemsTotal": "279.70",
###   "shippingTotal": "20.00",
###   "discountTotal": "0.00",
###   "grandTotal": "299.70",
###   "paymentMethod": "CREDIT_CARD",
###   "installments": 3,
###   "shippingCarrier": null,
###   "shippingService": null,
###   "shippingEstimatedDeliveryDate": null,
###   "shippingTrackingCode": null,
###   "anymarketRawPayload": { ... },
###   "extraData": null,
###   "anymarketCreatedAt": "2025-12-13T10:00:00.000Z",
###   "anymarketUpdatedAt": null,
###   "items": [
###     {
###       "id": 1,
###       "productId": 0,
###       "skuId": 30494035,
###       "title": "Camiseta Exemplo - P Vermelho",
###       "quantity": 2,
###       "unitPrice": "99.90",
###       "discount": "0.00",
###       "total": "199.80"
###     }
###   ],
###   "createdAt": "2025-12-13T10:00:00.000Z",
###   "updatedAt": "2025-12-13T10:30:00.000Z"
### }

### ===========================================
### STATUS DOS PEDIDOS - REFERÊNCIA COMPLETA
### ===========================================
### 
### INCOMPLETE (0)
###   - Pedido incompleto, aguardando informações
###   - Transição: Criado localmente, ainda sem AnyMarket
###
### PENDING (1)
###   - Pedido criado, aguardando integração AnyMarket
###   - Transição: Order criada localmente, AnyMarket pendente
###   - Próximo: WAITING_PAYMENT (após integração) ou erro
###
### WAITING_PAYMENT (2)
###   - Aguardando processamento de pagamento
###   - Transição: AnyMarket integrado, aguardando payment
###   - Próximo: PAID_WAITING_SHIP ou CANCELED
###
### PAID_WAITING_SHIP (3)
###   - Pagamento aprovado, aguardando envio
###   - Transição: Pagamento processado e aprovado
###   - Carrinho limpo automaticamente neste ponto
###   - Próximo: INVOICED
###
### INVOICED (4)
###   - Nota fiscal emitida
###   - Próximo: PAID_WAITING_DELIVERY
###
### PAID_WAITING_DELIVERY (5)
###   - Aguardando postagem/envio
###   - Próximo: IN_TRANSIT
###
### IN_TRANSIT (6)
###   - Em trânsito para o cliente
###   - shippingTrackingCode disponível
###   - Próximo: CONCLUDED ou DELIVERY_ISSUE
###
### DELIVERY_ISSUE (7)
###   - Problema na entrega
###   - Ação manual necessária
###
### CONCLUDED (8)
###   - Pedido entregue e concluído
###   - Estado final (sucesso)
###
### CANCELED (9)
###   - Pedido cancelado
###   - Estado final (falha)
###   - Pode ocorrer em WAITING_PAYMENT ou PAID_WAITING_SHIP
###
### ===========================================

### ===========================================
### MÉTODOS DE PAGAMENTO SUPORTADOS
### ===========================================
###
### PENDING (0)
###   - Método ainda não definido
###   - Estado inicial da order
###
### CREDIT_CARD (1)
###   - Cartão de crédito
###   - Suporta parcelamento (1-12x)
###   - Gateways: Mercado Pago, Cielo
###
### DEBIT_CARD (2)
###   - Cartão de débito
###   - Sempre à vista
###   - Gateways: Mercado Pago, Cielo
###
### PIX (3)
###   - Pagamento instantâneo
###   - Sempre à vista
###   - Apenas Mercado Pago
###   - Pagamento assíncrono (webhook)
###
### ===========================================

### ===========================================
### CAMPOS IMPORTANTES
### ===========================================
###
### checkoutKey
###   - UUID de idempotência da criação da order
###   - Amarrado ao profileId (evita acesso cruzado)
###   - Usado em /checkout/order
###
### partnerOrderId
###   - Formato: ECOM-{profileId}-{timestamp}
###   - Identificador único para integração AnyMarket
###
### anymarketOrderId
###   - ID do pedido no sistema AnyMarket
###   - null se integração AnyMarket falhou
###
### profileId
###   - Dono do pedido
###   - Usado para validação de autorização
###
### paymentMethod
###   - Definido após pagamento aprovado
###   - Valores: PENDING, CREDIT_CARD, DEBIT_CARD, PIX
###
### installments
###   - Número de parcelas (1-12)
###   - Apenas para CREDIT_CARD
###
### ===========================================

### ===========================================
### ERROS COMUNS
### ===========================================

### Erro 404: Pedido não encontrado

GET {{ordersUrl}}/999999
Authorization: Bearer {{token}}

### Erro 403: Pedido não pertence ao usuário logado

GET {{ordersUrl}}/1
Authorization: Bearer {{token}}

### Erro 400: ID de pedido inválido

GET {{ordersUrl}}/abc
Authorization: Bearer {{token}}

### Erro 401: Token ausente ou inválido

GET {{ordersUrl}}/1

### ===========================================
### INTEGRAÇÃO COM CHECKOUT
### ===========================================
### Para criar novos pedidos, consulte: checkout.http
###
### Fluxo completo:
### 1. Adicionar produtos ao carrinho (via /cart)
### 2. Processar checkout (/checkout/guest ou /checkout/registered)
### 3. Criar order (/checkout/order com X-Idempotency-Key)
### 4. Processar pagamento (/checkout/payment/:type/gateway/:gateway)
### 5. Consultar order aqui (/orders/:id)
### 6. Webhook atualiza status automaticamente (PIX)
### ===========================================

### ===========================================
### NOTAS TÉCNICAS
### ===========================================
###
### Idempotência:
### - Order criada com status PENDING
### - Após integração AnyMarket: WAITING_PAYMENT
### - Após pagamento aprovado: PAID_WAITING_SHIP
### - Race conditions tratadas com UniqueViolation
###
### Carrinho:
### - NÃO é limpo ao criar order (permite retry)
### - Limpo APENAS quando pagamento é aprovado
### - Status aprovado: carrinho zerado automaticamente
###
### AnyMarket:
### - Integração ocorre DEPOIS de criar order local
### - Falha no AnyMarket não impede criação da order
### - Order fica PENDING até integração bem-sucedida
###
### Webhook:
### - Atualiza orders de pagamentos assíncronos (PIX)
### - Consulta API do gateway antes de atualizar
### - Não confia apenas no payload recebido
### ===========================================
